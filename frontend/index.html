<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />

    <!-- Prevenir cache agressivo -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />

    <!-- Mobile Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Odowell" />

    <!-- Theme Color -->
    <meta name="theme-color" content="#16a34a" />
    <meta name="msapplication-TileColor" content="#16a34a" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="/icon.svg" />

    <title>Odowell - Gestão Odontológica</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Sistema completo de gestão para clínicas odontológicas" />
    <meta name="keywords" content="odontologia, gestão, clínica, dental, pacientes, agenda" />

    <!-- Limpar dados corrompidos ANTES do app carregar -->
    <script>
      (function() {
        // Versao do app - incrementar a cada deploy importante
        var APP_VERSION = '2026.01.04.2';

        try {
          // Verificar se localStorage está acessível
          var testKey = '__storage_test__';
          localStorage.setItem(testKey, testKey);
          localStorage.removeItem(testKey);

          // Verificar se a versao mudou - se sim, limpar tudo
          var savedVersion = localStorage.getItem('app_version');
          if (savedVersion !== APP_VERSION) {
            console.log('Nova versao detectada (' + APP_VERSION + '), limpando cache...');
            // Salvar dados importantes antes de limpar
            var token = localStorage.getItem('token');
            var user = localStorage.getItem('user');
            var tenant = localStorage.getItem('tenant');

            // Limpar tudo
            localStorage.clear();
            sessionStorage.clear();

            // Restaurar dados de login se validos
            if (token && user) {
              try {
                JSON.parse(user);
                localStorage.setItem('token', token);
                localStorage.setItem('user', user);
                if (tenant) {
                  JSON.parse(tenant);
                  localStorage.setItem('tenant', tenant);
                }
              } catch (e) {
                console.warn('Dados de login invalidos, fazendo logout');
              }
            }

            // Salvar nova versao
            localStorage.setItem('app_version', APP_VERSION);
            console.log('Cache limpo com sucesso');
          }

          // Verificar se os dados salvos são JSON válido
          var user = localStorage.getItem('user');
          if (user) {
            try {
              JSON.parse(user);
            } catch (e) {
              console.warn('Dados corrompidos detectados, limpando...');
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              localStorage.removeItem('tenant');
            }
          }
        } catch (e) {
          console.error('Erro ao acessar localStorage:', e);
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <!-- PWA Service Worker - DESATIVADO para garantir código atualizado -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          // Desregistrar TODOS os service workers para limpar cache
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            await registration.unregister();
            console.log('✓ Service Worker removido');
          }
          // Limpar TODOS os caches
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            console.log('✓ Cache limpo');
          }
          // NÃO re-registrar SW para garantir que código seja sempre atualizado
          console.log('✓ App pronto (sem Service Worker)');
        });
      }
    </script>
  </body>
</html>
